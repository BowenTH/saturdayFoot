<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/app.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/icons-extra.css"/>
		
		<header class="mui-bar mui-bar-nav" style="display: block;">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title">肉类</h1>
		    <a style="margin: 10px;z-index: 999;"  class="mui-icon-extra mui-icon-extra-share mui-pull-right"></a>
			<a  class="mui-icon mui-icon-search mui-pull-right"></a>  	
		</header>
		<style>
			.mui-row.mui-fullscreen>[class*="mui-col-"] {
				height: 100%;
			}
			
			.mui-col-xs-3,
			.mui-col-xs-9 {
				overflow-y: auto;
				height: 100%;
			}
			
			.mui-segmented-control .mui-control-item {
				line-height: 50px;
				width: 100%;
			}
			
			.mui-control-content {
				display: block;
			}
			
			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				background-color: #fff;
			}
		</style>
	</head>
	<body>
		<!--加侧栏-->
		<div  class="mui-content mui-row mui-fullscreen" style="margin-top: 50px;">
			<div class="mui-col-xs-3">
				<div id="segmentedControls" class="mui-segmented-control mui-segmented-control-inverted mui-segmented-control-vertical">

				</div>
			</div>
			<div id="segmentedControlContents" class="mui-col-xs-9" style="border-left: 1px solid #c8c7cc;">
			</div>
		</div>
		<!--end-->
		<!--menu list关闭开启-->
		<div id="menu-list"style="display: none;width: 100%;bottom: 45px;position: fixed;">
			<ul class="mui-table-view">
			</ul>
		</div>
		<div id="">		
			<button id="menu" type="button" data-id='1' class="mui-btn-grey"style="height: 50px;border-radius: 0;;width: 60%;position: fixed;bottom: 0px;">
				<span>菜单<span id="count-list" style="margin: -10px;" class="mui-badge mui-badge-red mui-btn-red mui-pull-right ">0</span></span>
			</button>
		        <button id="go" style="height: 50px;width: 40%;right: 0;background:lightblue;bottom: 0px;position: fixed;">
		         	<span id="" >
						结账：<span id='sum-finally'>0</span>元
					</span>					
		        </button>			
		</div>
		<script src="../../js/jquery.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/mui.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init({
				swipeBack: true //启用右滑关闭功能
			});
			var leftMenu=null;
			$.getJSON('../../data/typeData.json',function(result){
				leftMenu=result;
//				alert(JSON.stringify(result));
			});  
			 
			var controls = document.getElementById("segmentedControls");
			var contents = document.getElementById("segmentedControlContents");
			mui.later(doData,200);
		function doData(){
			var html = [];
			var i = 1,
				j = 1,
				m = 16, //左侧选项卡数量+1
				n = 21; //每个选项卡列表数量+1
//			添加实例
			//测试代码
			for (i=1; i <= leftMenu.length; i++) {
					html.push('<a class="mui-control-item a-active" data-index="' + (i - 1) + '" href="#content' + i + '">' + leftMenu[i-1].name + '</a>');
			}
			controls.innerHTML = html.join('');
			html = [];
			for (i = 1; i <=leftMenu.length; i++) {
				html.push('<div id="content' + i + '"  class="mui-control-content"><ul data-id="'+i+'" class="mui-table-view">');
				for (j = 1; j <= leftMenu[i-1].info.length; j++) {
						html.push('<li class="mui-table-view-cell" data-id="'+j+'">第' + i + '个选项卡子项-' + j  + leftMenu[i-1].info[j-1].name);
						html.push("<div class='mui-numbox' style='float: right; display:none'>");
						html.push("<button class='mui-btn mui-btn-numbox-minus'  type='button'>-</button>");
						html.push("<input id='countInput' class='mui-input-numbox' type='number' value='1'>");
						html.push("<button class='mui-btn mui-btn-numbox-plus' type='button'>+</button></div>");
						html.push("<span class='mui-icon mui-icon-plus mui-icon-plus-filled' style='color: red;float: right;font-size: 35px;' ></span>");
				}
				html.push('</li></ul></div>');
			}
			contents.innerHTML = html.join('');
			//默认选中第一个
			controls.querySelector('.mui-control-item').classList.add('mui-active');
			(function() {
				var controlsElem = document.getElementById("segmentedControls");
				var contentsElem = document.getElementById("segmentedControlContents");
				var controlListElem = controlsElem.querySelectorAll('.mui-control-item');
				var contentListElem = contentsElem.querySelectorAll('.mui-control-content');
				var controlWrapperElem = controlsElem.parentNode;
				var controlWrapperHeight = controlWrapperElem.offsetHeight;
				var controlMaxScroll = controlWrapperElem.scrollHeight - controlWrapperHeight;//左侧类别最大可滚动高度
				var maxScroll = contentsElem.scrollHeight - contentsElem.offsetHeight;//右侧内容最大可滚动高度
				var controlHeight = controlListElem[0].offsetHeight;//左侧类别每一项的高度
				var controlTops = []; //存储control的scrollTop值
				var contentTops = [0]; //存储content的scrollTop值
				var length = contentListElem.length;
				for (var i = 0; i < length; i++) {
					controlTops.push(controlListElem[i].offsetTop + controlHeight);
				}
				for (var i = 1; i < length; i++) {
					var offsetTop = contentListElem[i].offsetTop;
					if (offsetTop + 100 >= maxScroll) {
						var height = Math.max(offsetTop + 100 - maxScroll, 100);
						var totalHeight = 0;
						var heights = [];
						for (var j = i; j < length; j++) {
							var offsetHeight = contentListElem[j].offsetHeight;
							totalHeight += offsetHeight;
							heights.push(totalHeight);
						}
						for (var m = 0, len = heights.length; m < len; m++) {
							contentTops.push(parseInt(maxScroll - (height - heights[m] / totalHeight * height)));
						}
						break;
					} else {
						contentTops.push(parseInt(offsetTop));
					}
				}
				contentsElem.addEventListener('scroll', function() {
					var scrollTop = contentsElem.scrollTop;
					for (var i = 0; i < length; i++) {
						var offsetTop = contentTops[i];
						var offset = Math.abs(offsetTop - scrollTop);
//						console.log("i:"+i+",scrollTop:"+scrollTop+",offsetTop:"+offsetTop+",offset:"+offset);
						if (scrollTop < offsetTop) {
							if (scrollTop >= maxScroll) {
								onScroll(length - 1);
							} else {
								onScroll(i - 1);
							}
							break;
						} else if (offset < 20) {
							onScroll(i);
							break;
						}else if(scrollTop >= maxScroll){
							onScroll(length - 1);
							break;
						}
					}
				});
				var lastIndex = 0;
				//监听content滚动
				var onScroll = function(index) {
					if (lastIndex !== index) {
						lastIndex = index;
						var lastActiveElem = controlsElem.querySelector('.mui-active');
						lastActiveElem && (lastActiveElem.classList.remove('mui-active'));
						lastActiveElem && (lastActiveElem.classList.remove('a-active'));
						var currentElem = controlsElem.querySelector('.mui-control-item:nth-child(' + (index + 1) + ')');
						currentElem.classList.add('mui-active');
						currentElem.classList.add('a-active');
						//简单处理左侧分类滚动，要么滚动到底，要么滚动到顶
						var controlScrollTop = controlWrapperElem.scrollTop;
						if (controlScrollTop + controlWrapperHeight < controlTops[index]) {
							controlWrapperElem.scrollTop = controlMaxScroll;
						} else if (controlScrollTop > controlTops[index] - controlHeight) {
							controlWrapperElem.scrollTop = 0;
						}
					}
				};
				//滚动到指定content
				var scrollTo = function(index) {
					contentsElem.scrollTop = contentTops[index];
				};
//				测试代码
				mui(controlsElem).on('tap', '.mui-control-item', function(e) {
					var aflag = this;
					for (var i=0;i<$('a').length;i++) {
						if($('a').eq(i).hasClass('a-active'))
						$('a').eq(i).removeClass('a-active');
						$(aflag).addClass('a-active');
					}
					scrollTo(this.getAttribute('data-index'));
					return false;
				});
				
//				mui($('#segmentedControlContents')).on('tap','li',function(){
//					mui.openWindow('detail/menuList.html','menuList.html');
//				})；

	/*处理按钮操作事件*/
			var listcount=0;
			var foodsum=0;
			mui('.mui-control-content').on('tap','.mui-btn-numbox-plus',function(){
			var flag=$(this).siblings('.mui-input-numbox').val();
			flag++;			
			$(this).siblings('.mui-input-numbox').val(flag);
			listcount++;//购买菜单种类加1; 
//			var sigle=$(this).parent().siblings('.food-type').children().text();
//			
//			var data=parseInt(sigle);
			foodsum+=10;//总额	 
			$('#sum-finally').text(foodsum);
			$('#count-list').text(listcount);			
			//动态添加menulist的数目 1，2，3，4			
//			var listname=$(this).parent().siblings('.food-type').text();
			//获取到数据信息，猪肉
			var ulId = $(this).parents("ul").data('id');
			var liId = $(this).parents("li").data('id');
			var listname=leftMenu[ulId-1].info[liId-1].name;
			
//			var span =$('#menu-list li');
			var span= $("#menu-list ul li:contains("+listname+")");
			$(span).children('span').last().text(flag);
		});
//3 -	
		mui('.mui-control-content').on('tap','.mui-btn-numbox-minus',function(){
			var flag=$(this).siblings('.mui-input-numbox').val();
			flag--;
			$(this).siblings('.mui-input-numbox').val(flag);
			if ($(this).siblings('.mui-input-numbox').val()<0) {//numbox值不能小于0
				$(this).siblings('.mui-input-numbox').val(0);
				return; 
			}
			listcount--;//如果不买该种类水果，listcount--；
//			var sigle=$(this).parent().siblings('.food-type').children().text();
//			var data=parseInt(sigle);
			foodsum-=10;//总额			
			$('#sum-finally').text(foodsum);
			$('#count-list').text(listcount);
			//动态添加menulist的数目 1，2，3，4
			var ulId = $(this).parents("ul").data('id');
			var liId = $(this).parents("li").data('id');
			var listname=leftMenu[ulId-1].info[liId-1].name;
//			var listname=$(this).parent().siblings('.food-type').text();
			var span= $("#menu-list li:contains("+listname+")");
			$(span).children('span').last().text(flag);
		});
//3 0+
		mui('.mui-control-content').on('tap','.mui-icon-plus-filled',function(){
			this.style.display='none'; 
//			input里显示购买量
			$(this).siblings('.mui-numbox').css({'display':'inline'});
//			var sigle=$(this).siblings('.food-type').children().text();
//			var data=parseInt(sigle);
			listcount++;//购买菜单种类加1;
			foodsum+=10;
			$('#sum-finally').text(foodsum);
			$('#count-list').text(listcount);
		//加入菜单主列表
			var li = document.createElement('li');
			$(li).addClass('mui-table-view-cell food-type');
			var foodcount=$(this).siblings().children('.mui-input-numbox').val();//1
			li.dataset.foodcount=foodcount;//1
			var ulId = $(this).parents("ul").data('id');
			var liId = $(this).parents("li").data('id');
			var listname=leftMenu[ulId-1].info[liId-1].name;
			li.dataset.listname = listname;
//			li.dataset.listname = $(this).parent().find('.food-type').html();//粉木耳
			//添加菜单列表具体内容 foodcount为一单个数
			
			li.innerHTML= li.dataset.listname+'<span class="mui-badge mui-badge-green mui-btn-green mui-pull-right ">'+li.dataset.foodcount+'</span>';
			document.body.querySelector('#menu-list ul').appendChild(li);
		});
		
			document.getElementById('menu').addEventListener('tap',function(){
			if($(this).data('id')==1){
				$('#menu-list').css("display","block");
				$(this).data('id','0');
			}else{
				$('#menu-list').css("display","none");
				$(this).data('id','1');
			}
		});
		
		/* 支付宝支付引用  */
var channel =null;
function plusReady(){
	document.getElementById('go').addEventListener('tap',function(){
	mui.toast('结算金额:'+foodsum);
	//生成订单
//	alert(shopName);	
	var checklist=[];
	$list=$('#menu-list ul li');

//	alert($('#menu-list .sigle:eq(1)').text());
//	alert($('#menu-list .mui-badge:eq(1)').text());
	for (var i=0;i<$('#menu-list ul li').length;i++) {
		var flag={'name': $('#menu-list .food-type:eq('+i+')').text(),
			'price':$('#menu-list .sigle:eq('+i+')').text(),
			'count':$('#menu-list .mui-badge:eq('+i+')').text()
		}
		checklist.push(flag);
	}
//	alert(JSON.stringify(checklist));
	//订单导入数据库 
	var db = openDatabase('testDB', '1.0', 'Test DB', 2 * 1024 * 1024);
	db.transaction(function (context) {
       	    context.executeSql('CREATE TABLE IF NOT EXISTS LshopData (shopname unique, checklist)');
     		context.executeSql('INSERT INTO LshopData (shopname,checklist) values (?,?)',
       		[shopName,JSON.stringify(checklist)]);  
       });

	plus.payment.getChannels(function(channels){
	channel=channels[0];
	},function(e){
		alert('获取支付通道失败:'+e.message);
	});
	pay('alipay');
//	pay('weixin');
})
}
document.addEventListener('plusready',plusReady,false);
var ALLPAYSERVER='http://demo.dcloud.net.cn/helloh5/payment/alipay.php?total=';
//var ALLPAYSERVER='https://bowenth.github.io/';
var WXPAYSERVER='http://demo.dcloud.net.cn/helloh5/payment/wxpay.php?total=';



//2.发起支付请求
function pay(id){
 var PAYSERVER='';
    if(id=='alipay'){
        PAYSERVER=ALLPAYSERVER;
//      alert('发起支付请求')
    }else if(id=='weixin'){
    	alert('微信支付哟');
        PAYSERVER=WXPAYSERVER;
    }else{
        plus.nativeUI.alert("不支持此支付通道！",null,"捐赠");
        return;
    }
    var xhr=new XMLHttpRequest();
    xhr.onreadystatechange=function(){
//  	alert('判断');
        switch(xhr.readyState){
            case 4:
            if(xhr.status==200){
                plus.payment.request(channel,xhr.responseText,function(result){
                    plus.nativeUI.alert("支付成功！",function(){
                        back();
                    });
                },function(error){
                    plus.nativeUI.alert("支付失败：" + error.code);
                });
            }else{
                alert("获取订单信息失败！");
            }
            break;
            default:
            break;
        }
    }
    xhr.open('GET',PAYSERVER);
    xhr.send();
}
			})();
		}
		</script>
	</body>
</html>
